---
title: ""
---

```{r}
#| echo: false
#| warning: false
# TODO: refactor this into a fn
vancouver_df <- readRDS("data/vancouver.rds") |> 
  dplyr::filter(stringr::str_detect(moneda, "EUR"))  |> 
  dplyr::mutate(source = paste0("Vancouver ", moneda)) |> 
  dplyr::mutate(direction = "COP -> EUR") |> 
  dplyr::select(timestamp, source, rate = valor_venta, direction)

visa_df <- readRDS("data/visa.rds") |> 
  dplyr::mutate(source = "Visa") |> 
  dplyr::mutate(direction = "EUR -> COP") |> 
  dplyr::select(timestamp, source, rate = visa_rate, direction)

master_df <- readRDS("data/master.rds") |> 
  dplyr::mutate(source = "Master") |> 
  dplyr::mutate(direction = "EUR -> COP") |> 
  dplyr::select(timestamp, source, rate = master_rate, direction)

nu_df <- readRDS("data/nu.rds") |> 
  dplyr::mutate(source = "Nu") |> 
  dplyr::mutate(direction = "COP -> EUR") |> 
  dplyr::select(timestamp, source, rate = nu_rate, direction)

condor_df <- readRDS("data/condor.rds") |> 
  dplyr::filter(stringr::str_detect(moneda, "EUR"))  |> 
  dplyr::mutate(source = paste0("Condor ", moneda)) |> 
  dplyr::mutate(direction = "COP -> EUR") |> 
  dplyr::select(timestamp, source, rate = venta, direction)

comdirect_df <- readRDS("data/comdirect.rds") |> 
  dplyr::filter(iso == "COP")  |> 
  dplyr::mutate(source = "Comdirect") |> 
  dplyr::mutate(direction = "EUR -> COP") |> 
  dplyr::select(timestamp, source, rate = geld, direction)

kapital_df <- readRDS("data/kapital.rds") |> 
  dplyr::filter(stringr::str_detect(moneda, "EUR"))  |> 
  dplyr::mutate(source = paste0("Kapital ", moneda)) |> 
  dplyr::mutate(direction = "COP -> EUR") |> 
  dplyr::select(timestamp, source, rate = venta, direction)

eurcop_df <- dplyr::bind_rows(
  vancouver_df, visa_df, master_df, condor_df, 
  comdirect_df, kapital_df, nu_df
) |> 
  dplyr::group_by(timestamp) |> 
  dplyr::mutate(
    spread = 
      max(vctrs::vec_slice(rate, direction == "EUR -> COP"), na.rm = TRUE) - 
      min(vctrs::vec_slice(rate, direction == "COP -> EUR"), na.rm = TRUE)
  )  |> 
  dplyr::ungroup()
```
```{r}
#| label: rates-dygraphs-plot
#| echo: false

rates_df <- eurcop_df |> 
  dplyr::select(timestamp, source, rate) |> 
  tidyr::pivot_wider(
    names_from = source, 
    values_from = rate, 
    values_fn = mean # to deal with those cases where id_cols and names_from 
    # columns does not uniquely identify an observation. Not sure how it 
    # happened, but there are a few where we have for the same source,
    # more than one observation with the same timestamp
  )

rates_xts <- xts::xts(
  x = rates_df |> dplyr::select(-timestamp) |> as.data.frame(), 
  order.by = rates_df$timestamp
)

rates_dy <- 
  dygraphs::dygraph(
  	data = rates_xts,
  	group = "eurcop_plot"
  ) |> 
  dygraphs::dyAxis(name = "x", rangePad = 5) |>
  dygraphs::dyLegend(width = 700) |>
  dygraphs::dyOptions(drawPoints = TRUE, pointSize = 2) |>
  dygraphs::dyRangeSelector() |>
  dygraphs::dyHighlight(
    highlightCircleSize = 5,
    highlightSeriesBackgroundAlpha = 0.2,
    hideOnMouseOut = TRUE
  )

rates_dy$x$css <- 
  ".dygraph-legend > span {display:none;}
   .dygraph-legend > span.highlight { display: inline; float: right}
  "
rates_dy
```


```{r}
#| label: spread-dygraphs-plot
#| echo: false

spread_df <- eurcop_df |> 
  dplyr::group_by(timestamp) |> 
  dplyr::summarize(spread = mean(spread, na.rm = TRUE))

spread_xts <- xts::xts(
  x = spread_df|> dplyr::select(-timestamp), 
  order.by = spread_df$timestamp
)

spread_dy <- 
  dygraphs::dygraph(
  	data = spread_xts,
  	group = "eurcop_plot"
  ) |>
  dygraphs::dyAxis(name = "x", rangePad = 5) |>
  dygraphs::dyLegend(width = 700) |>
  dygraphs::dyOptions(drawPoints = TRUE, pointSize = 2) |>
  dygraphs::dyRangeSelector() |>
  dygraphs::dyHighlight(
    highlightCircleSize = 5,
    highlightSeriesBackgroundAlpha = 0.3,
    hideOnMouseOut = TRUE
  )

spread_dy$x$css <- 
  ".dygraph-legend > span {display:none;}
   .dygraph-legend > span.highlight { display: inline; float: right}
  "
spread_dy
```
